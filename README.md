# http_based_file_storage

## Пример использования

```go
// Читает .env, при отсутсвии логирует ошибку
config := server.ReadConfigFromEnv()

	storage, err := storage.NewStorage(config.StoragePath)
	if err != nil {
		panic(err)
	}

	server, err := server.NewHTTPFileStorageServer(storage, config)
	if err != nil {
		panic(err)
	}

	server.StartServer()
```

## Реализация хранилища файлов

### Сохранение файла

Файл читается из запроса и сохраняется во временном файле. После этого берётся хэш этого файла и сравнивается с хэшами, переданными в хэдерах запроса, если такие были. Далее файл сохраняется по пути `$storageRoot/store/ab/ab12345678`, где `ab12345678` это sha1 хэш файла.

Возвращает следующие ответы:

- 200 если файл с таким названием уже существует
- 201 если файл был успешно создан
- 412 если хэши переданные в хэдерах запроса не совпадают с вычисленными на сервере при обработке запроса
- 500 при внутренней ошибке

Как вариант, можно при попытке записи уже существующего файла проверять хэш запсианного файла, и проверять повреждёл ли файл при записи.

### Чтение файла

Чтение файла происходит по переданному хэшу после преобразования в локальный путь. При чтении файла проверяется хэш содержимого и сравнивается с названием файла, чтобы проверить, не повреждён ли файл.

Возвращает следующие ответы:

- 200 при правильной обработке запроса
- 404 если файла с таким хэшом не нашлось
- 500 в случае серверных ошибок, а так же несовпадающего хэша фактического файла, и хэша при сохранении

### Удаление файла

Удаление будет происходить по переданному хэшу, в случае если файла не найдено, не возвращает ошибку.

Возвращает следующие ответы:

- 200 если файл был удалён или его не было на диске
- 500 при внутренних ошибках

## Модификация сервера

### Добавление обработчиков файла до или после сохранения

`FileStorageServer.RegisterPreSaveCallback` и `FileStorageServer.RegisterPostSaveCallback` добавляют обработчики в список.

### Добавление middleware

`FileStorageServer.AddMiddleware` добавляет функцию в список middleware для обработки запросов.

### Добавление дополнительных роутов

`FileStorageServer.RegisterPOSTSaveCallback`, `FileStorageServer.RegisterGETHandler`, `FileStorageServer.RegisterPOSTHandler`, `FileStorageServer.RegisterDELETEHandler`добавляют соответствуенные обработчики в роутер.

## Дальнейшее улучшение

### Докеризация

Обязательно потом сделать докер файл, где сервер будет стартовать для автоматизации тестирования через CI и улучшения CD

### Лимиты на соединения с одного ip и введение rps limit

Самое логичное в данном случае первоначально настроить nginx, в котором наверняка есть все нужные настройки

### Redis для хранения метаданных

Добавить редис для хранения размера файла, имени, переданного пользователем, счётчик скачиваний.

### Подсчёт занимаемого хранилищем места

Завести счётчик, сохраняемый в файле (либо noSql бд) внутри `store`. Актуализация счётчика при удалении или загрузке файлов. При превышении заданного лимита, удалять давно неиспользованные файлы.
Для этого можно хранить в редисе последнюю дату скачивания, и удалять самые неиспользуемые.
